<div class="statusChange">
  <div class="header">
    <div class="title">{{ data.title }}</div>
    <!-- <div class="id"><span> </span><b></b></div> -->

    <div class="header-right">
      <button
        class="save-popup"
        mat-raised-button
        (click)="statusChanged()"
        [disabled]="!canSave()"
      >
        Save
      </button>
      <div class="title-divider">|</div>
      <div class="close-circle">
        <mat-icon
          id="dialogCloseButton"
          matSuffix
          class=""
          (click)="closeDialog()"
          style="font-size: 14px; display: inline; position:relative; top:-1px; "
          >close</mat-icon
        >
      </div>
    </div>
  </div>
  <div class="more-info row" *ngIf="data?.lab">
    <div class="header-title mg-b-5 plr-0 col-6">
      Main info:
    </div>
    <div class="header-title text-right mg-b-5 plr-0 col-6">
      <span class="subheader-field">Labs ID:</span>
      <a href="/#/labs/labresult/edit/{{ data.lab }}" target="_blank">
        <span
          class="aggridlink-darktheme"
          [ngClass]="{ darkTheme: switchTheme, lightTheme: !switchTheme }"
          >{{ data.lab }}</span
        >
      </a>
    </div>
    <div class="header-title mg-t-5 plr-0 col-6">
      <span class="subheader-field">Vessel:</span
      ><span class="subheader-value">{{ data.vessel }}</span>
    </div>
    <div class="col-6 header-title mg-t-5 plr-0 text-right">
      <span class="subheader-field">Port:</span
      ><span class="subheader-value">{{ data.port }}</span>
    </div>
  </div>
  <div
    class="more-info row"
    *ngIf="
      data.popupType == 'rob' ||
      data.popupType == 'supply' ||
      data.popupType == 'sludge'
    "
  >
    <div class="header-title mg-b-5 plr-0 col-6">
      Main info:
    </div>
    <div class="header-title text-right mg-b-5 plr-0 col-6"></div>
    <div class="header-title mg-t-5 plr-0 col-6">
      <span class="subheader-field">Vessel:</span
      ><span class="subheader-value">{{ data.vessel }}</span>
    </div>
    <div class="col-6 header-title mg-t-5 plr-0 text-right">
      <span class="subheader-field">Port:</span
      ><span class="subheader-value">{{ data.port }}</span>
    </div>
  </div>
  <div class="more-info mg-b-0 ">
    <div class="row info-section">
      <ng-container *ngIf="data.popupType != 'qualityLabs'; else qualityLabs">
        <div
          class=" w-20p plr-0"
          *ngIf="data.popupType == 'rob' || data.popupType == 'supply'"
        >
          <div class="col-header">Product Type</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{ value.productType }}
          </div>
        </div>
        <div class=" w-20p plr-0" *ngIf="data.popupType == 'sludge'">
          <div class="col-header">Sludge %</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{ format.quantity(value.sludgePercentage) }}
          </div>
        </div>
        <div
          class="w-24p plr-0"
          *ngIf="data.popupType == 'rob' || data.popupType == 'sludge'"
        >
          <div class="col-header">Log Book ROB</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{ format.quantity(value.logBookRobQtyBeforeDelivery) }}
          </div>
        </div>
        <div class="w-24p plr-0" *ngIf="data.popupType == 'supply'">
          <div class="col-header">BDN Quantity</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{ format.quantity(value.bdnQuantity) }}
          </div>
        </div>
        <div class=" w-24p plr-0">
          <div class="col-header">{{ data.measuredQuantityLabel }}</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{
              data.popupType == 'rob' || data.popupType == 'sludge'
                ? format.quantity(value.measuredRobQtyBeforeDelivery)
                : format.quantity(value.measuredQuantity)
            }}
          </div>
        </div>
        <div class=" w-20p plr-0">
          <div class="col-header">{{ data.differenceQuantityLabel }}</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{
              data.popupType == 'rob' || data.popupType == 'sludge'
                ? format.quantity(value.differenceInRobQuantity)
                : format.quantity(value.differenceQuantity)
            }}
          </div>
        </div>
        <div class=" w-10p plr-0">
          <div class="col-header">UOM</div>
          <div *ngFor="let value of data.productTypeList" class="col-value">
            {{ value.uom }}
          </div>
        </div>
      </ng-container>
    </div>
    <ng-template #qualityLabs>
      <div class=" w-28 plr-0">
        <div class="col-header">Lab Counterparty</div>
        <div *ngFor="let value of data.productTypeList" class="col-value">
          {{ this.format.htmlDecode(value.labCounterParty) }}
        </div>
      </div>
      <div class=" w-28 plr-0">
        <div class="col-header">Product</div>
        <div *ngFor="let value of data.productTypeList" class="col-value">
          {{ this.format.htmlDecode(value.product) }}
        </div>
      </div>
      <div class=" w-24p plr-0">
        <div class="col-header">Lab Status</div>
        <div *ngFor="let value of data.productTypeList" class="col-value">
          {{ value.labStatus }}
        </div>
      </div>
      <div class=" w-20p plr-0">
        <div class="col-header">Claim Raised</div>
        <div *ngFor="let value of data.productTypeList" class="col-value">
          {{ value.claimRaised }}
        </div>
      </div>
    </ng-template>
  </div>

  <div class="action-status">
    <div class="header-title">Action Status</div>
    <div
      id="custom-form-field"
      [ngClass]="{ darkTheme: switchTheme, lightTheme: !switchTheme }"
    >
      <mat-form-field class="without-search" appearance="none">
        <mat-label>Select Field</mat-label>
        <mat-select
          disableOptionCentering
          [(ngModel)]="status"
          [(value)]="defaultStatus"
          [panelClass]="{ darkPanelBg: switchTheme }"
          (selectionChange)="changeStatus($event.value); isDataChanged($event.value, 'status');"
        >
          <mat-option
            *ngFor="let value of controlTowerActionStatus"
            value="{{ value.id }}"
            >{{ value.displayName }}</mat-option
          >
        </mat-select>
      </mat-form-field>
    </div>
    <div class="header-title">Comments</div>
    <textarea
      [ngModel]="comments | htmlDecodeReadonly"
      (ngModelChange)="comments = $event; isDataChanged($event, 'comments');"
      spellcheck="false"
      maxlength="500"
    ></textarea>
    <span class="text-danger" *ngIf="comments && comments.trim()==''">Please enter valid comments</span>
    <div class="link">
      <span>In relation to:</span>
      <span *ngIf="data.portCall">
        Port Call:
        <a
          href="/v2/quantity-control/report/{{ data.quantityReportId }}/details"
          target="_blank"
        >
          <span
            class="aggridlink-darktheme"
            [ngClass]="{ darkTheme: switchTheme, lightTheme: !switchTheme }"
            >{{ data.portCall }}</span
          >
        </a>
      </span>
      <ng-container *ngIf="data.popupType == 'qualityLabs'">
        <span>
          Order No:
          <a href="/#/edit-order/{{ data.orderId }}" target="_blank">
            <span
              class="aggridlink-darktheme"
              [ngClass]="{ darkTheme: switchTheme, lightTheme: !switchTheme }"
              >{{ data.orderId }}</span
            >
          </a>
        </span>
        <span>
          Delivery No:
          <a
            href="/v2/delivery/delivery/{{ data.deliveryId }}/details"
            target="_blank"
          >
            <span class="aggridlink-darktheme">{{ data.deliveryId }}</span>
          </a>
        </span>
      </ng-container>
    </div>
  </div>
  <div class="change-log col-12" *ngIf="data.changeLog?.length">
    <div class="header-title">Change Log</div>
    <div class="list-section" *ngIf="data.changeLog">
      <!-- <div
        class="list"
        style="width:100%"
        *ngFor="let value of data.changeLog.slice().reverse()"
      >
        <span></span>
        <p>{{ formatDateTo12Hrs(value.date) }}</p>
        <div class="description">
          <div class="p-0 pt-1 pb-2 description-comments">
            {{ value.user.name | htmlDecodeReadonly }} :
            <em>{{ value.newComments | htmlDecodeReadonly }}</em>
          </div>
        </div>
      </div> -->
      <div
      style="width:100%"
      class="list"
      *ngFor="let value of data.changeLog.slice().reverse()"
      >
      <!-- temporary template fix without logStatus "status | comment | both"  -->
      <ng-container *ngIf="!(value?.logStatus)">
          <span></span>
          <p class="log_status" *ngIf="value.newStatus?.displayName">
            Issue {{ value.newStatus.displayName | htmlDecodeReadonly }} by
            {{ value.user.name | htmlDecodeReadonly }}
          </p>
          <br />
          <p
          style="padding-left: 13px;line-height: 14px;"
          class="log_comment"
          *ngIf="value.newComments"
          >
            <!-- {{ value.user.name | htmlDecodeReadonly }} : -->
            <em>{{ value.newComments | htmlDecodeReadonly }}</em>
          </p>
          <div class="description">{{ formatDateTo12Hrs(value.date) }}</div>
        </ng-container>

        <ng-container *ngIf="value?.logStatus">
          <span></span>
          <p class="log_status" *ngIf="value.newStatus?.displayName && (value?.logStatus=='status' || value?.logStatus=='both')">
            Issue {{ value.newStatus.displayName | htmlDecodeReadonly }} by
            {{ value.user.name | htmlDecodeReadonly }}
          </p>
          <p
            style="line-height: 14px;"
            [ngStyle]="(value?.logStatus=='both')? {'padding': '5px 0 5px 13px', 'clear': 'both'}: {'clear': 'none', 'padding': '0 0 5px 5px'}"
            class="log_comment"
            *ngIf="value.newComments && (value?.logStatus=='comment' || value?.logStatus=='both')"
          >
          <ng-container *ngIf="value.logStatus && value?.logStatus=='comment'">
            {{ value.user.name | htmlDecodeReadonly }} :
          </ng-container>
            <em>{{ value.newComments | htmlDecodeReadonly }}</em>
          </p>
          <div class="description">{{ formatDateTo12Hrs(value.date) }}</div>
        </ng-container>
        </div>
    </div>
  </div>
</div>
